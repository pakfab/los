<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Summit Of Voices</title>
    <!-- Library untuk Export PDF dan Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h1, h2 { color: #333; text-align: center; }
        .dashboard-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-grow: 1; }
        .controls { width: 100%; max-width: 400px; }
        .results { width: 100%; max-width: 500px; }
        .voter-list { width: 100%; max-width: 920px; }
        .control-button { display: block; width: 100%; padding: 15px; margin-bottom: 10px; font-size: 18px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #reset-button { background-color: #007bff; }
        #reset-button:hover { background-color: #0056b3; }
        #export-excel, #export-pdf { background-color: #28a745; }
        #export-excel:hover, #export-pdf:hover { background-color: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f7f7f7; }
        .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; }
        .progress-bar { height: 24px; background-color: #4caf50; border-radius: 5px; text-align: right; color: white; padding-right: 5px; line-height: 24px; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>Dashboard Panitia</h1>

    <div class="dashboard-container">
        <div class="card controls">
            <h2>Kontrol Pemilihan</h2>
            <button id="reset-button" class="control-button">Buka Sesi Voting Baru</button>
            <button id="export-excel" class="control-button">Export Hasil ke Excel</button>
            <button id="export-pdf" class="control-button">Export Hasil ke PDF</button>
        </div>

        <div class="card results">
            <h2>Rekapitulasi Suara</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Kandidat</th>
                        <th>Perolehan Suara</th>
                        <th>Persentase</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data hasil akan dimuat oleh JavaScript -->
                </tbody>
            </table>
            <h3 style="margin-top:20px;">Total Suara Masuk: <span id="total-votes">0</span></h3>
        </div>
    </div>

    <div class="dashboard-container" style="margin-top: 20px;">
        <div class="card voter-list">
            <h2>Daftar Pemilih</h2>
            <table id="voters-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Pemilih</th>
                        <th>Kelas</th>
                        <th>Memilih</th>
                        <th>Waktu</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Daftar pemilih akan dimuat oleh JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultsTableBody = document.querySelector('#results-table tbody');
    const votersTableBody = document.querySelector('#voters-table tbody');
    const totalVotesSpan = document.getElementById('total-votes');
    const resetButton = document.getElementById('reset-button');
    const exportExcelButton = document.getElementById('export-excel');
    const exportPdfButton = document.getElementById('export-pdf');

    // Ganti dengan URL Apps Script Anda
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl5fSvv4zDf8Aaxr1LVaPu0xEe_cICClJHDwES8l2YsrZOTW-jddHkdemjTIsWIT8/exec";

    // Variabel global untuk menyimpan data terbaru
    let currentVoters = [];
    let currentCandidates = [];

    async function fetchDashboardData() {
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            if (data.result === 'success') {
                // Ambil daftar kandidat dari localStorage (untuk info foto, dll)
                const candidateInfo = JSON.parse(localStorage.getItem('candidates')) || [];
                
                // Gabungkan data suara dari Sheet dengan info kandidat
                const candidatesWithVotes = candidateInfo.map(c => ({
                    ...c,
                    votes: data.voteCounts[c.name] || 0
                }));

                currentVoters = data.voters;
                currentCandidates = candidatesWithVotes;
                updateDashboardUI(currentCandidates, currentVoters);
            } else {
                throw new Error(data.error || 'Unknown error from script');
            }
        } catch (error) {
            console.error("Gagal mengambil data:", error);
            votersTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Gagal memuat data. Periksa koneksi atau URL Script.</td></tr>`;
        }
    }

    function updateDashboardUI(candidates, voters) {
        const totalVotes = candidates.reduce((sum, c) => sum + c.votes, 0);

        // Update tabel hasil
        resultsTableBody.innerHTML = '';
        candidates.forEach(candidate => {
            const percentage = totalVotes > 0 ? ((candidate.votes / totalVotes) * 100).toFixed(1) : 0;
            const row = `
                <tr>
                    <td>${candidate.name}</td>
                    <td>${candidate.votes}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%;">${percentage}%</div>
                        </div>
                    </td>
                </tr>
            `;
            resultsTableBody.innerHTML += row;
        });
        totalVotesSpan.textContent = totalVotes;

        // Update tabel pemilih
        votersTableBody.innerHTML = '';
        voters.forEach((voter, index) => {
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${voter.name}</td>
                    <td>${voter.class}</td>
                    <td>${voter.votedFor}</td>
                    <td>${voter.timestamp}</td>
                </tr>
            `;
            votersTableBody.innerHTML += row;
        });
    }

    function resetVotingSession() {
        // Mengubah status menjadi 'tidak terkunci'
        localStorage.setItem('electionState', JSON.stringify({ isLocked: false }));
        alert('Sesi voting baru telah dibuka! Halaman coblos sekarang aktif.');
    }

    function exportToExcel() {
        const ws1_data = [
            ["Kandidat", "Jumlah Suara"],
            ...currentCandidates.map(c => [c.name, c.votes])
        ];
        const ws2_data = [
            ["No", "Nama Pemilih", "Kelas", "Memilih", "Waktu"],
            ...currentVoters.map((v, i) => [i + 1, v.name, v.class, v.votedFor, v.timestamp])
        ];

        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.aoa_to_sheet(ws1_data);
        const ws2 = XLSX.utils.aoa_to_sheet(ws2_data);

        XLSX.utils.book_append_sheet(wb, ws1, "Rekap Suara");
        XLSX.utils.book_append_sheet(wb, ws2, "Daftar Pemilih");

        XLSX.writeFile(wb, "Hasil_Pemilihan_OSIS.xlsx");
    }

    function exportToPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const totalVotes = currentCandidates.reduce((sum, c) => sum + c.votes, 0);

        doc.setFontSize(18);
        doc.text("Laporan Hasil Pemilihan Ketua OSIS", 14, 22);
        
        doc.setFontSize(12);
        doc.text(`Total Suara Masuk: ${totalVotes}`, 14, 30);

        // Tabel Rekap Suara
        doc.autoTable({
            startY: 35,
            head: [['Kandidat', 'Jumlah Suara', 'Persentase']],
            body: currentCandidates.map(c => [
                c.name, 
                c.votes, 
                totalVotes > 0 ? ((c.votes / totalVotes) * 100).toFixed(1) + '%' : '0%'
            ]),
            theme: 'grid'
        });

        // Tabel Daftar Pemilih
        doc.addPage();
        doc.setFontSize(18);
        doc.text("Daftar Pemilih", 14, 22);
        doc.autoTable({
            startY: 30,
            head: [['No', 'Nama Pemilih', 'Kelas', 'Memilih', 'Waktu']],
            body: currentVoters.map((v, i) => [i + 1, v.name, v.class, v.votedFor, v.timestamp]),
            theme: 'grid'
        });

        doc.save("Hasil_Pemilihan_OSIS.pdf");
    }

    // Event Listeners
    resetButton.addEventListener('click', resetVotingSession);
    exportExcelButton.addEventListener('click', exportToExcel);
    exportPdfButton.addEventListener('click', exportToPdf);

    // Muat data saat halaman dibuka, lalu muat ulang setiap 10 detik
    fetchDashboardData();
    setInterval(fetchDashboardData, 10000); // 10000 ms = 10 detik
});
</script>

</body>
</html>
