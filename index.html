<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summit Of Voices - Pemilihan Ketua OSIS SMA ISLAM AL AZHAR 16 SEMARANG</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 90%; max-width: 800px; }
        h1, h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .candidates { display: flex; justify-content: space-around; margin-top: 30px; flex-wrap: wrap; }
        .candidate { text-align: center; margin: 15px; }
        .candidate .photo-pair { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .candidate .photo-pair img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ddd; }
        .candidate h3 { margin: 10px 0 5px; }
        .vote-button { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .vote-button:hover { background-color: #0056b3; }
        .vote-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #message { text-align: center; margin-top: 20px; font-size: 1.2em; font-weight: bold; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .locked { color: #ffc107; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pemilihan Ketua OSIS</h1>
        <div id="voter-form">
            <div class="form-group">
                <label for="voterName">Nama Lengkap</label>
                <input type="text" id="voterName" placeholder="Masukkan nama Anda">
            </div>
            <div class="form-group">
                <label for="voterClass">Pilih Kelas</label>
                <select id="voterClass">
                    <option value="">-- Pilih Kelas --</option>
                    <option>Ibnu Sina</option>
                    <option>Ibnu Khaldun</option>
                    <option>Ibnu Haytham</option>
                    <option>Al Khawarizmi</option>
                    <option>Al Kindi</option>
                    <option>Al Syatiby</option>
                    <option>Al Farabi</option>
                    <option>Al Battani</option>
                    <option>Al Jabbar</option>
                    <option>Al Farghani</option>
                    <option>Al Ghazali</option>
                </select>
            </div>
        </div>

        <hr>

        <h2>Calon Ketua OSIS</h2>
        <div id="candidates-container" class="candidates">
            <!-- Kandidat akan dimuat oleh JavaScript -->
        </div>

        <div id="message"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const candidatesContainer = document.getElementById('candidates-container');
    const voterNameInput = document.getElementById('voterName');
    const voterClassSelect = document.getElementById('voterClass');
    const messageDiv = document.getElementById('message');

    // Inisialisasi data jika belum ada di localStorage
    function initializeData() {
        if (!localStorage.getItem('candidates')) {
            const initialCandidates = [
                { id: 1, name: "Paslon 1", votes: 0, photo_ketua: "caketos1.jpg", photo_wakil: "cawaketos1.jpg" },
                { id: 2, name: "Paslon 2", votes: 0, photo_ketua: "caketos2.jpg", photo_wakil: "cawaketos2.jpg" },
                { id: 3, name: "Paslon 3", votes: 0, photo_ketua: "caketos3.jpg", photo_wakil: "cawaketos3.jpg" }
            ];
            localStorage.setItem('candidates', JSON.stringify(initialCandidates));
        }
        if (!localStorage.getItem('voters')) {
            localStorage.setItem('voters', JSON.stringify([]));
        }
        if (!localStorage.getItem('electionState')) {
            localStorage.setItem('electionState', JSON.stringify({ isLocked: false }));
        }
    }

    function renderCandidates() {
        const candidates = JSON.parse(localStorage.getItem('candidates'));
        candidatesContainer.innerHTML = '';
        candidates.forEach(candidate => {
            const candidateDiv = document.createElement('div');
            candidateDiv.className = 'candidate';
            candidateDiv.innerHTML = `
                <div class="photo-pair">
                    <img src="${candidate.photo_ketua}" alt="Calon Ketua ${candidate.name}">
                    <img src="${candidate.photo_wakil}" alt="Calon Wakil Ketua ${candidate.name}">
                </div>
                <h3>${candidate.name}</h3>
                <button class="vote-button" data-id="${candidate.id}">Pilih</button>
            `;
            candidatesContainer.appendChild(candidateDiv);
        });
        addVoteButtonListeners();
        checkElectionState();
    }

    function addVoteButtonListeners() {
        document.querySelectorAll('.vote-button').forEach(button => {
            button.addEventListener('click', handleVote);
        });
    }

    function handleVote(event) {
        const voterName = voterNameInput.value.trim();
        const voterClass = voterClassSelect.value;

        if (!voterName || !voterClass) {
            showMessage('Nama dan Kelas harus diisi!', 'error');
            return;
        }

        // Nonaktifkan tombol sementara untuk mencegah klik ganda
        document.querySelectorAll('.vote-button').forEach(b => b.disabled = true);
        showMessage('Sedang memproses suara Anda...', 'locked');

        const candidateId = parseInt(event.target.getAttribute('data-id'));
        
        // Ambil data kandidat dari localStorage (untuk nama dan update suara)
        let candidates = JSON.parse(localStorage.getItem('candidates'));
        const candidateIndex = candidates.findIndex(c => c.id === candidateId);
        candidates[candidateIndex].votes++;
        localStorage.setItem('candidates', JSON.stringify(candidates));

        // --- PERUBAHAN UTAMA: Kirim data ke Google Spreadsheet ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl5fSvv4zDf8Aaxr1LVaPu0xEe_cICClJHDwES8l2YsrZOTW-jddHkdemjTIsWIT8/exec"; // <-- GANTI DENGAN URL ANDA
        const votedForName = candidates[candidateIndex].name;

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Penting untuk request sederhana ke Apps Script
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ voterName: voterName, voterClass: voterClass, votedFor: votedForName })
        })
        .then(response => {
            // Kunci sesi pemilihan setelah data berhasil dikirim
            lockElection();
            showMessage(`Terima kasih ${voterName} dari kelas ${voterClass}, suara Anda telah dicatat!`, 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Gagal menyimpan suara. Periksa koneksi internet dan hubungi panitia.', 'error');
            // Aktifkan kembali tombol jika gagal
            document.querySelectorAll('.vote-button').forEach(b => b.disabled = false);
        });
    }

    function lockElection() {
        localStorage.setItem('electionState', JSON.stringify({ isLocked: true }));
        disableVoting();
        showMessage('Sesi pemilihan ini telah selesai. Silakan panggil panitia untuk pemilih berikutnya.', 'locked');
    }

    function disableVoting() {
        document.querySelectorAll('.vote-button').forEach(button => button.disabled = true);
        voterNameInput.disabled = true;
        voterClassSelect.disabled = true;
    }

    function enableVoting() {
        document.querySelectorAll('.vote-button').forEach(button => button.disabled = false);
        voterNameInput.disabled = false;
        voterClassSelect.disabled = false;
        voterNameInput.value = '';
        voterClassSelect.value = '';
        messageDiv.innerHTML = '';
    }

    function checkElectionState() {
        const state = JSON.parse(localStorage.getItem('electionState'));
        if (state.isLocked) {
            disableVoting();
            showMessage('Sesi pemilihan terkunci. Tunggu panitia untuk memulai sesi baru.', 'locked');
        } else {
            enableVoting();
        }
    }

    function showMessage(msg, type) {
        messageDiv.textContent = msg;
        messageDiv.className = type;
    }
    
    // Listen for changes from other tabs (e.g., dashboard)
    window.addEventListener('storage', (event) => {
        if (event.key === 'electionState') {
            checkElectionState();
        }
    });

    // Initial setup
    initializeData();
    renderCandidates();
});
</script>

</body>
</html>
