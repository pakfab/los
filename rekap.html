<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recapitulation - Summit Of Voices</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2c3e50; color: white; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 90%; max-width: 1000px; background-color: #34495e; padding: 40px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        h1 { text-align: center; font-size: 3em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h2 { text-align: center; font-size: 1.5em; margin-top: 0; margin-bottom: 40px; font-weight: 300; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; }
        .candidate-card { background: #46637f; padding: 20px; border-radius: 10px; text-align: center; }
        .candidate-card .photo-pair { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .candidate-card .photo-pair img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #ecf0f1; object-fit: cover; }
        .candidate-card h3 { font-size: 1.8em; margin: 15px 0 10px; }
        .votes { font-size: 2.5em; font-weight: bold; color: #f1c40f; }
        .progress-bar-container { width: 100%; background-color: #2c3e50; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 30px; background: linear-gradient(90deg, #1abc9c, #16a085); border-radius: 10px; text-align: center; color: white; font-weight: bold; line-height: 30px; transition: width 0.5s ease-in-out; }
        #total-votes-display { text-align: center; font-size: 2em; margin-top: 40px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Count</h1>
        <h2>Pemilihan Ketua OSIS</h2>
        
        <div id="results-grid" class="results-grid">
            <!-- Hasil akan dimuat oleh JavaScript -->
        </div>

        <div id="total-votes-display">
            Total Suara: <span id="total-votes">0</span>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultsGrid = document.getElementById('results-grid');
    const totalVotesSpan = document.getElementById('total-votes');

    // Ganti dengan URL Apps Script Anda
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl5fSvv4zDf8Aaxr1LVaPu0xEe_cICClJHDwES8l2YsrZOTW-jddHkdemjTIsWIT8/exec";

    async function fetchDataAndUpdateUI() {
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            if (data.result !== 'success') throw new Error(data.error || 'Unknown script error');

            // Ambil info kandidat (nama, foto) dari localStorage
            const candidateInfo = JSON.parse(localStorage.getItem('candidates')) || [];
            
            // Gabungkan data suara dari Sheet dengan info kandidat
            const candidatesWithVotes = candidateInfo.map(c => ({
                ...c,
                votes: data.voteCounts[c.name] || 0
            }));

            updateUI(candidatesWithVotes);

        } catch (error) {
            console.error("Gagal mengambil data:", error);
            resultsGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #ffc107;">Gagal memuat data. Mencoba lagi...</p>`;
        }
    }

    function updateUI(candidates) {
        const totalVotes = candidates.reduce((sum, c) => sum + c.votes, 0);

        resultsGrid.innerHTML = '';
        
        if (candidates.length === 0) {
            resultsGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Menunggu data pemilihan...</p>';
            return;
        }

        candidates.forEach(candidate => {
            const percentage = totalVotes > 0 ? ((candidate.votes / totalVotes) * 100).toFixed(1) : 0;
            const card = `
                <div class="candidate-card">
                    <div class="photo-pair">
                        <img src="${candidate.photo_ketua}" alt="Calon Ketua ${candidate.name}">
                        <img src="${candidate.photo_wakil}" alt="Calon Wakil Ketua ${candidate.name}">
                    </div>
                    <h3>${candidate.name}</h3>
                    <div class="votes">${candidate.votes}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${percentage}%;">${percentage}%</div>
                    </div>
                </div>
            `;
            resultsGrid.innerHTML += card;
        });

        totalVotesSpan.textContent = totalVotes;
    }

    // Muat data saat halaman dibuka, lalu muat ulang setiap 5 detik
    fetchDataAndUpdateUI();
    setInterval(fetchDataAndUpdateUI, 5000); // 5000 ms = 5 detik
});
</script>

</body>
</html>
